name: PR Staging Cleanup

on:
  pull_request:
    types: [closed]
    branches: [master, main]

jobs:
  cleanup-staging:
    name: Cleanup PR Staging Environment
    runs-on: ubuntu-latest
    environment: production  # Reuse production secrets for Azure access

    steps:
      - name: Setup environment variables
        id: setup
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          RESOURCE_GROUP="rg-teamskills-pr${PR_NUMBER}"
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "resource_group=${RESOURCE_GROUP}" >> $GITHUB_OUTPUT

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ vars.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ vars.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}"}'

      - name: Check if resource group exists
        id: check_rg
        run: |
          if az group show --name ${{ steps.setup.outputs.resource_group }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete staging resource group
        if: steps.check_rg.outputs.exists == 'true'
        run: |
          echo "Deleting resource group ${{ steps.setup.outputs.resource_group }}..."
          az group delete \
            --name ${{ steps.setup.outputs.resource_group }} \
            --yes \
            --no-wait
          echo "Resource group deletion initiated (async)"

      - name: Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.setup.outputs.pr_number }};
            const merged = ${{ github.event.pull_request.merged }};
            const status = merged ? 'ðŸŽ‰ Merged' : 'âŒ Closed';
            
            // Find existing staging comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const stagingComment = comments.data.find(c => 
              c.body.includes('ðŸš€ **PR Staging Environment**') && 
              c.user.type === 'Bot'
            );
            
            if (stagingComment) {
              const body = `ðŸš€ **PR Staging Environment**

              **Status:** ðŸ—‘ï¸ Destroyed

              The staging environment for this PR has been cleaned up.
              PR was ${status.toLowerCase()}.
              `;
              
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: stagingComment.id,
                body: body
              });
            }

      - name: Cleanup summary
        run: |
          echo "## ðŸ—‘ï¸ PR Staging Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_rg.outputs.exists }}" == "true" ]; then
            echo "Resource group **${{ steps.setup.outputs.resource_group }}** deletion initiated." >> $GITHUB_STEP_SUMMARY
          else
            echo "Resource group **${{ steps.setup.outputs.resource_group }}** did not exist (already cleaned up)." >> $GITHUB_STEP_SUMMARY
          fi
