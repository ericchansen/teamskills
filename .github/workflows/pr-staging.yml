name: PR Staging Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [master, main]

permissions:
  contents: read
  pull-requests: write

env:
  # Production ACR to reuse (avoids duplicate registry costs)
  ACR_NAME: crgvojq4dgzbtk4
  ACR_RESOURCE_GROUP: rg-teamskills-prod
  STAGING_RESOURCE_GROUP: rg-teamskills-staging
  LOCATION: centralus

jobs:
  deploy-staging:
    name: Deploy PR Staging Environment
    runs-on: ubuntu-latest
    environment: staging
    
    outputs:
      frontend_url: ${{ steps.deploy.outputs.frontendUrl }}
      backend_url: ${{ steps.deploy.outputs.backendUrl }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup environment variables
        id: setup
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ vars.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ vars.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}"}'

      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push backend image
        run: |
          docker build -f Dockerfile.backend \
            -t ${{ env.ACR_NAME }}.azurecr.io/backend:${{ steps.setup.outputs.image_tag }} .
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:${{ steps.setup.outputs.image_tag }}

      - name: Build and push frontend image
        run: |
          PR_NUMBER=${{ steps.setup.outputs.pr_number }}
          BACKEND_URL="https://ca-backend-pr${PR_NUMBER}.$(az containerapp env list -g ${{ env.STAGING_RESOURCE_GROUP }} --query "[0].properties.defaultDomain" -o tsv 2>/dev/null || echo 'placeholder.centralus.azurecontainerapps.io')"
          
          docker build -f Dockerfile.frontend \
            --build-arg VITE_API_URL=${BACKEND_URL} \
            --build-arg VITE_AZURE_AD_CLIENT_ID=${{ vars.AZURE_AD_CLIENT_ID || '' }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ steps.setup.outputs.image_tag }} .
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ steps.setup.outputs.image_tag }}

      - name: Generate PostgreSQL password
        id: pg_password
        run: |
          PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 24)
          echo "::add-mask::${PASSWORD}"
          echo "password=${PASSWORD}" >> $GITHUB_OUTPUT

      - name: Deploy staging infrastructure
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.STAGING_RESOURCE_GROUP }}
          template: ./infra/staging/main.bicep
          parameters: >
            prNumber=${{ steps.setup.outputs.pr_number }}
            postgresPassword=${{ steps.pg_password.outputs.password }}
            imageTag=${{ steps.setup.outputs.image_tag }}
            acrName=${{ env.ACR_NAME }}
            acrResourceGroup=${{ env.ACR_RESOURCE_GROUP }}
            location=${{ env.LOCATION }}
          failOnStdErr: false

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend to be ready..."
          BACKEND_URL="${{ steps.deploy.outputs.backendUrl }}"
          for i in {1..30}; do
            if curl -s "${BACKEND_URL}/health" | grep -q "ok"; then
              echo "Backend is ready!"
              break
            fi
            echo "Attempt $i: Backend not ready yet, waiting..."
            sleep 10
          done

      - name: Initialize database with seed data
        run: |
          BACKEND_URL="${{ steps.deploy.outputs.backendUrl }}"
          INIT_SECRET="${{ steps.deploy.outputs.initSecret }}"
          
          echo "Initializing database..."
          RESPONSE=$(curl -s -X POST "${BACKEND_URL}/api/admin/init" \
            -H "Content-Type: application/json" \
            -d "{\"secret\": \"${INIT_SECRET}\"}")
          
          echo "Database init response: ${RESPONSE}"

      - name: Comment on PR with staging URLs
        uses: actions/github-script@v7
        with:
          script: |
            const frontendUrl = '${{ steps.deploy.outputs.frontendUrl }}';
            const backendUrl = '${{ steps.deploy.outputs.backendUrl }}';
            const prNumber = ${{ steps.setup.outputs.pr_number }};
            const sha = '${{ github.sha }}';
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const stagingComment = comments.data.find(c => 
              c.body.includes('ðŸš€ **PR Staging Environment**') && 
              c.user.type === 'Bot'
            );
            
            const body = `ðŸš€ **PR Staging Environment**

            | Resource | URL |
            |----------|-----|
            | **Frontend** | ${frontendUrl} |
            | **Backend** | ${backendUrl} |
            | **Health Check** | ${backendUrl}/health |

            **Commit:** \`${sha.substring(0, 7)}\`
            **Status:** âœ… Deployed

            > This environment will be automatically destroyed when the PR is closed or merged.
            `;
            
            if (stagingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: stagingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

      - name: Deployment summary
        run: |
          echo "## ðŸš€ PR Staging Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **Frontend** | ${{ steps.deploy.outputs.frontendUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Backend** | ${{ steps.deploy.outputs.backendUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
