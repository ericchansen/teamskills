name: PR Staging Cleanup

on:
  pull_request:
    types: [closed]
    branches: [master, main]

permissions:
  contents: read
  pull-requests: write

env:
  STAGING_RESOURCE_GROUP: rg-teamskills-staging

jobs:
  cleanup-staging:
    name: Cleanup PR Staging Environment
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Setup environment variables
        id: setup
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ vars.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ vars.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}"}'

      - name: Delete PR staging resources
        id: cleanup
        run: |
          PR_NUMBER=${{ steps.setup.outputs.pr_number }}
          RG="${{ env.STAGING_RESOURCE_GROUP }}"
          DELETED=0

          echo "Cleaning up staging resources for PR #${PR_NUMBER} in ${RG}..."

          # Delete Container Apps first (they depend on the environment)
          for APP in $(az containerapp list -g "$RG" --query "[?tags.\"pr-number\"=='${PR_NUMBER}'].name" -o tsv 2>/dev/null); do
            echo "Deleting Container App: ${APP}"
            az containerapp delete -g "$RG" -n "$APP" --yes --no-wait
            DELETED=$((DELETED + 1))
          done

          # Delete Container Apps Environment
          for ENV in $(az containerapp env list -g "$RG" --query "[?tags.\"pr-number\"=='${PR_NUMBER}'].name" -o tsv 2>/dev/null); do
            echo "Deleting Container Apps Environment: ${ENV}"
            az containerapp env delete -g "$RG" -n "$ENV" --yes --no-wait
            DELETED=$((DELETED + 1))
          done

          # Delete PostgreSQL Flexible Server
          for PG in $(az postgres flexible-server list -g "$RG" --query "[?tags.\"pr-number\"=='${PR_NUMBER}'].name" -o tsv 2>/dev/null); do
            echo "Deleting PostgreSQL server: ${PG}"
            az postgres flexible-server delete -g "$RG" -n "$PG" --yes
            DELETED=$((DELETED + 1))
          done

          # Delete Log Analytics Workspace
          for LOG in $(az monitor log-analytics workspace list -g "$RG" --query "[?tags.\"pr-number\"=='${PR_NUMBER}'].name" -o tsv 2>/dev/null); do
            echo "Deleting Log Analytics workspace: ${LOG}"
            az monitor log-analytics workspace delete -g "$RG" -n "$LOG" --yes --force
            DELETED=$((DELETED + 1))
          done

          echo "deleted_count=${DELETED}" >> $GITHUB_OUTPUT
          echo "Cleanup complete. Deleted ${DELETED} resources."

      - name: Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.setup.outputs.pr_number }};
            const merged = ${{ github.event.pull_request.merged }};
            const status = merged ? 'ðŸŽ‰ Merged' : 'âŒ Closed';
            const deletedCount = '${{ steps.cleanup.outputs.deleted_count }}';
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const stagingComment = comments.data.find(c => 
              c.body.includes('ðŸš€ **PR Staging Environment**') && 
              c.user.type === 'Bot'
            );
            
            if (stagingComment) {
              const body = `ðŸš€ **PR Staging Environment**

              **Status:** ðŸ—‘ï¸ Destroyed (${deletedCount} resources removed)

              The staging environment for this PR has been cleaned up.
              PR was ${status.toLowerCase()}.
              `;
              
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: stagingComment.id,
                body: body
              });
            }

      - name: Cleanup summary
        run: |
          echo "## ðŸ—‘ï¸ PR Staging Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deleted **${{ steps.cleanup.outputs.deleted_count }}** resources for PR #${{ steps.setup.outputs.pr_number }} from **${{ env.STAGING_RESOURCE_GROUP }}**." >> $GITHUB_STEP_SUMMARY
